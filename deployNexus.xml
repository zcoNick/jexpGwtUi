<?xml version="1.0" encoding="UTF-8"?>
<project name="jexpGwtUi" default="default" xmlns:jexpdep="com.javexpress.studio.dependency.ant">

	<target name="default">
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		  <classpath>
		    <pathelement location="${basedir}/../jexpApplication/ant-contrib-1.0b3.jar"/>
		  </classpath>
		</taskdef>

		<property file="${basedir}/../jexpApplication/build.params"/>
		<property file="lastdeploy.properties"/>		

		<jexpdep:path id="project.classpath" conf="*" dependencies="${basedir}/jexpGwtFw.jexpdep" />

		<property name="myproperty" refid="project.classpath"/>
		<echo message="${myproperty}"/> 

		<path id="gwt.sdk.classpath">
	        <fileset dir="${GWTSDK}">
	            <include name="**/*.jar"/>
	        </fileset>
	    </path>

		<property name="PROJECTDIR" value="${basedir}"/>
		<property name="TEMPDIR" value="${basedir}/jarTemp"/>
		<delete dir="${TEMPDIR}" />
		<mkdir dir="${TEMPDIR}/bin"/>
		<javac destdir="${TEMPDIR}/bin" debug="off" encoding="UTF-8" target="1.6" source="1.6">
			<classpath>
				<path refid="project.classpath" />
				<pathelement location="${basedir}/../jexpApplication/bin" />
				<path refid="gwt.sdk.classpath" />
			</classpath>
			<src path="${PROJECTDIR}/library" />
			<src path="${PROJECTDIR}/fw" />
			<src path="${PROJECTDIR}/fw_DB" />
			<src path="${PROJECTDIR}/test" />
		</javac>

	    <tstamp>
	        <format property="builtat" pattern="yyyyMMddhhmm"/>
	    </tstamp>		
		<jexpdep:versionInfo dependencies="${basedir}/jexpGwtFw.jexpdep" buildId="${builtat}" buildDate="${builtat}" user="${user.name}" outFolder="${basedir}/fw" outJava="com.javexpress.gwt.fw.shared.VersionInfo" implementing="com.javexpress.application.model.item.IVersionInfo"/>
		<jexpdep:jiraReleaseNotes dependencies="${basedir}/jexpGwtFw.jexpdep" baseURL="${jira.host}" credentials="${jira.credentials}" jiraProject="JEXPGWTFW" outXml="${PROJECTDIR}/fw/jexpGwtFw-releaseNotes.xml" proxyHost="${proxy.host}"/>

		<property name="SDKJAR" value="${TEMPDIR}/jexpGwtFw.jar"/>
		<delete file="${SDKJAR}"/>		
		<jar destfile="${TEMPDIR}/jexpGwtFwDEBUG.jar" index="true">
			<fileset dir="${TEMPDIR}/bin"/>
			<fileset dir="${PROJECTDIR}/library">
				<include name="**/client/**"/>
				<include name="**/shared/**"/>
				<include name="**/ui/**"/>
				<include name="**/public/**"/>
			    <include name="**/*.xml"/>
			    <include name="**/*.jexpuid"/>
			</fileset>
			<fileset dir="${PROJECTDIR}/fw">
				<include name="**/client/**"/>
				<include name="**/shared/**"/>
				<include name="**/public/**"/>
				<include name="**/schema/**"/>
			    <include name="**/*.dtd"/>
			    <include name="**/*.xml"/>
			    <include name="**/*.csv"/>
			    <include name="**/*.jrxml"/>
			    <include name="**/*.jexprqd"/>
			    <include name="**/*.jexpuid"/>
			    <include name="*.jexpuis"/>
			    <include name="*.jexpwtp"/>
			    <include name="jexpGwtFwModelSettings.xml"/>
			</fileset>
			<fileset dir="${PROJECTDIR}/fw_DB">
				<include name="**/shared/**"/>
			</fileset>
		</jar>

		<!--taskdef name="yguard" classname="com.yworks.yguard.YGuardTask" classpath="${basedir}/../jexpApplication/yguard-2.5.2.jar"/>
		<yguard>
			<inoutpair in="${TEMPDIR}/jexpGwtFwDEBUG.jar" out="${SDKJAR}"/>
		    <externalclasses>
		    	<path refid="project.classpath"/>
		    	<pathelement location="${basedir}/../jexpApplication/bin" />
		       	<path refid="gwt.sdk.classpath"/>
		    </externalclasses>
			<rename logfile="${TEMPDIR}/${ant.project.name}_renamelog.xml">
				<property name="error-checking" value="pedantic"/>
				<keep>
					<class classes="protected" methods="private" fields="private">
						<patternset>
							<include name="com.javexpress.gwt.**.shared.**.*"/>
							<include name="com.javexpress.gwt.**.ui.**.*"/>
							<include name="com.javexpress.gwt.**.client.**.*"/>
						</patternset>
					</class>
					<class classes="protected" methods="protected" fields="protected">
						<patternset>
							<include name="test.**.*"/>
							<include name="com.javexpress.gwt.**.server.**.*"/>
						</patternset>
					</class>
					<class classes="public" methods="protected" fields="protected" extends="com.javexpress.application.test.BaseWebApplicationTestCase"/>
					<class classes="public" methods="protected" fields="protected" implements="com.javexpress.application.webservice.server.ISecuredWS"/>
				</keep>
			</rename>
		</yguard-->
		<move file="${TEMPDIR}/jexpGwtFwDEBUG.jar" tofile="${SDKJAR}"/>

		<jexpdep:publish jar="${SDKJAR}" dependencies="${basedir}/jexpGwtFw.jexpdep" baseURL="${nexus.host}/service/local" repository="${nexus.repository}" credentials="${nexus.credentials}" proxyHost="${proxy.host}"/>
		<delete dir="${TEMPDIR}/bin" failonerror="true"/>
		
		<if>
			<equals arg1="${lastdeployedversion}" arg2="${jexpGwtFw.jira.version}" />
		 <then>
			<property name="releaseinfo" value="The JavExpress Gwt Framework (${jexpGwtFw.jira.version}) is updated."/>
			<property name="partnerreleaseaction" value="Since this is a patch release please &lt;strong&gt;remove existing com.javexpress/jexp-gwt-fw folder from your .jexpDependency folder&lt;/strong&gt; and then resolve dependencies again."/>
		 </then>
		 <else>
			<property name="releaseinfo" value="The new version (${jexpGwtFw.jira.version}) of JavExpress Gwt Framework is available!"/>
			<property name="partnerreleaseaction" value="Please resolve dependencies again and &lt;strong&gt;dont forget to modify your persistence.xml&lt;/strong&gt;"/>
		 </else>
		</if>		
		<mail enableStartTLS="${MAILSTARTTLS}" ssl="${MAILSSL}" mailhost="${MAILHOST}" mailport="${MAILPORT}" user="${MAILUSER}" password="${MAILPASS}"
					encoding="mime" messagemimetype="text/html"
					tolist="${MAILTO}"
					cclist="${MAILCC}"
					subject="JavExpress / Gwt Framework updated!" failonerror="false">
			<from name="JavExpress Gwt Framework" address="gwtfw@javexpress.com"/>
			<message><![CDATA[<i>Dear Partner,</i><br/><br/>
				${releaseinfo} ${partnerreleaseaction}<br/>
				<br/>
				Regards,<br/>
				<strong>JavExpress Team</strong>
			]]></message>			
		</mail>
		<if>
			<equals arg1="${lastdeployedversion}" arg2="${jexpGwtFw.jira.version}" />
				<then>
			 	</then>
		 	<else>
				<propertyfile file="lastdeploy.properties">
					<entry key="lastdeployedversion" value="${jexpGwtFw.jira.version}"/>
				</propertyfile>
			</else>
		</if>
	</target>

</project>